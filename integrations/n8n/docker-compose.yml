version: '3.8'

services:
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      # Autenticación básica
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}

      # Configuración de host
      - N8N_HOST=${N8N_HOST:-0.0.0.0}
      - N8N_PORT=${N8N_PORT:-5678}
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678/}

      # Timezone
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE:-America/Mexico_City}
      - TZ=${GENERIC_TIMEZONE:-America/Mexico_City}

      # Performance
      - N8N_PAYLOAD_SIZE_MAX=16  # MB
      - EXECUTIONS_PROCESS=main
      - EXECUTIONS_TIMEOUT=300   # 5 minutos max por workflow
      - EXECUTIONS_TIMEOUT_MAX=600  # 10 minutos absoluto

      # Logging
      - N8N_LOG_LEVEL=${N8N_LOG_LEVEL:-info}
      - N8N_LOG_OUTPUT=${N8N_LOG_OUTPUT:-console}

      # Ejecuciones (retention)
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_ON_PROGRESS=true
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=168  # 7 días

      # Variables de entorno personalizadas (accesibles en workflows)
      - SUPABASE_DB_HOST=${SUPABASE_DB_HOST}
      - SUPABASE_DB_PORT=${SUPABASE_DB_PORT:-5432}
      - SUPABASE_DB_NAME=${SUPABASE_DB_NAME:-postgres}
      - SUPABASE_DB_USER=${SUPABASE_DB_USER:-postgres}
      - SUPABASE_DB_PASSWORD=${SUPABASE_DB_PASSWORD}
      - BIND_API_URL=${BIND_API_URL}
      - BIND_API_TOKEN=${BIND_API_TOKEN}

    volumes:
      # Persistir datos de n8n (workflows, credenciales, ejecuciones)
      - n8n_data:/home/node/.n8n

      # Opcional: Montar workflows locales (útil para desarrollo)
      # - ./workflows:/home/node/.n8n/workflows

    networks:
      - n8n_network

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  n8n_data:
    driver: local
    name: n8n_data

networks:
  n8n_network:
    driver: bridge
    name: n8n_network
